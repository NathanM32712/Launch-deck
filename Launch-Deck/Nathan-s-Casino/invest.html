<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>invest</title>
  <link rel="icon" type="image/png" href="icon.png" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #000;
      --panel: #111;
      --border: #333;
      --up: #00ff7f;
      --down: #ff4d4d;
      --text: #fff;
      --muted: #bbb;
    }
    html,body { height:100%; margin:0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      text-align: center;
      padding: 18px;
      box-sizing: border-box;
    }
    a.logo {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 100;
      display:inline-block;
      background: black;
      border-radius:6px;
      padding:4px;
    }
    a.logo img { height:60px; display:block; border-radius:4px; }
    h1 { margin: 8px 0 14px; font-size:20px; }
    .info { margin-bottom:12px; line-height:1.6; }
    .label { font-weight:700; color:var(--muted); margin-right:6px; }
    .controls { margin-bottom:14px; }
    input[type="number"] {
      width:160px;
      padding:8px;
      font-size:15px;
      border-radius:6px;
      border:1px solid var(--border);
      background: #0b0b0b;
      color:var(--text);
    }
    button {
      margin-left:6px;
      padding:8px 12px;
      font-size:15px;
      border-radius:6px;
      border:1px solid var(--border);
      background:#0f0f0f;
      color:var(--text);
      cursor:pointer;
    }
    canvas {
      background: var(--panel);
      display:block;
      margin: 12px auto;
      border:1px solid var(--border);
      max-width:100%;
      width:800px;
      height:400px;
    }
    .small { font-size:13px; color:var(--muted); }
    .row { display:inline-block; margin:0 10px; }
  </style>
</head>
<body>
<button type="button" onclick="window.location.href='home.html'">Go Home</button>
  <h1>ðŸ“Š Gamble Candlestick Game</h1>

  <div class="info">
    <div class="row"><span class="label">Balance:</span><span id="balance">0</span></div>
    <div class="row"><span class="label">Active Investment:</span><span id="investment">0</span></div>
    <div class="row"><span class="label">Live Value:</span><span id="livevalue">0</span></div>
  </div>

  <div class="controls">
    <input id="betamount" type="number" placeholder="Enter bet amount" min="0" step="1" />
    <button id="betBtn">Bet</button>
    <button id="cashBtn">Cash Out</button>
    <button id="reBtn">Reinvest</button>
    <button id="resetBtn" title="Reset balance to 1000">Reset</button>
  </div>

  <canvas id="graph" width="800" height="400" aria-label="candlestick graph"></canvas>

  <script>
    // Centralized cookie key
    const BALANCE_KEY = 'slotsBalance';

    // Canvas + context
    const canvas = document.getElementById('graph');
    const ctx = canvas.getContext('2d');

    // State
    let multipliers = [0];        // cumulative multiplier values (start at 0)
    let investment = 0;           // current invested amount
    let multiplier = 0;           // current multiplier (last value)
    let balance = readCookie(BALANCE_KEY) ?? 1000;
    let maxPoints = 50;           // initial horizontal capacity (normal view)
    const MIN_VERTICAL = 10;      // start vertical scale Â±10
    const UPDATE_MS = 1500;       // update interval

    // DOM
    const balanceEl = document.getElementById('balance');
    const investEl = document.getElementById('investment');
    const liveEl = document.getElementById('livevalue');
    const betInput = document.getElementById('betamount');
    const betBtn = document.getElementById('betBtn');
    const cashBtn = document.getElementById('cashBtn');
    const reBtn = document.getElementById('reBtn');
    const resetBtn = document.getElementById('resetBtn');

    // Helpers: cookie read/write
    function readCookie(name) {
      const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return m ? parseFloat(m[2]) : null;
    }
    function writeCookie(name, value) {
      document.cookie = `${name}=${value}; path=/`;
    }

    // Display update
    function updateDisplay() {
      balanceEl.textContent = Number(balance).toFixed(2);
      investEl.textContent = Number(investment).toFixed(2);
      liveEl.textContent = Number(investment * multiplier).toFixed(2);
    }

    // Betting controls
    function placeBet() {
      const amt = Number(betInput.value) || 0;
      if (amt > 0 && amt <= balance) {
        balance -= amt;
        investment += amt;
        writeCookie(BALANCE_KEY, balance.toFixed(2));
        updateDisplay();
      }
    }
    function cashOut() {
      const payout = investment * multiplier;
      balance += payout;
      investment = 0;
      writeCookie(BALANCE_KEY, balance.toFixed(2));
      updateDisplay();
    }
    function reInvest() {
      const amt = Number(betInput.value) || 0;
      if (amt > 0 && amt <= balance) {
        balance -= amt;
        investment += amt;
        writeCookie(BALANCE_KEY, balance.toFixed(2));
        updateDisplay();
      }
    }
    function resetBalance() {
      balance = 1000;
      writeCookie(BALANCE_KEY, balance.toFixed(2));
      updateDisplay();
    }

    // Graph update: cumulative addition, random -10..+10
    function updateGraph() {
      const last = multipliers[multipliers.length - 1] ?? 0;
      const change = Math.random() * 20 - 10; // -10..+10
      const next = last + change;
      multipliers.push(next);
      multiplier = next;

      // Only expand horizontal capacity when data truly exceeds normal view.
      // If the number of points exceeds maxPoints, we increase maxPoints gradually
      // so the graph will "squish" only when it gets too far to the right.
      if (multipliers.length > maxPoints) {
        maxPoints += 10;
      }

      drawCandles();
      updateDisplay();
    }

    // Draw candles with vertical scale starting at Â±MIN_VERTICAL and expanding as needed.
    function drawCandles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const w = canvas.width;
      const h = canvas.height;

      // Horizontal: normal until count > maxPoints, then squish to fit
      const count = multipliers.length;
      const visibleSlots = Math.max(maxPoints, count);
      const step = w / visibleSlots;
      const candleWidth = Math.max(2, step * 0.6);

      // Vertical scale: start at Â±MIN_VERTICAL, expand to max absolute value seen
      const maxAbs = Math.max(MIN_VERTICAL, ...multipliers.map(v => Math.abs(v)));

      // Draw center line (0)
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, h / 2);
      ctx.lineTo(w, h / 2);
      ctx.stroke();

      // Optional grid labels for top, 0, bottom
      ctx.fillStyle = '#888';
      ctx.font = '12px system-ui, Arial';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';
      ctx.fillText('+' + maxAbs.toFixed(0), 6, 6);
      ctx.textBaseline = 'middle';
      ctx.fillText('0', 6, h / 2);
      ctx.textBaseline = 'bottom';
      ctx.fillText('-' + maxAbs.toFixed(0), 6, h - 6);

      // Draw candles
      for (let i = 1; i < count; i++) {
        const x = i * step;
        const prev = multipliers[i - 1];
        const curr = multipliers[i];

        // Map value to canvas Y (top = -maxAbs, bottom = +maxAbs)
        const yPrev = h / 2 - (prev / maxAbs) * (h / 2);
        const yCurr = h / 2 - (curr / maxAbs) * (h / 2);

        const top = Math.min(yPrev, yCurr);
        const bottom = Math.max(yPrev, yCurr);
        ctx.fillStyle = curr >= prev ? getComputedStyle(document.documentElement).getPropertyValue('--up') || '#00ff7f' : getComputedStyle(document.documentElement).getPropertyValue('--down') || '#ff4d4d';
        ctx.fillRect(x - candleWidth / 2, top, candleWidth, Math.max(1, bottom - top));
      }
    }

    // Wire up buttons
    betBtn.addEventListener('click', placeBet);
    cashBtn.addEventListener('click', cashOut);
    reBtn.addEventListener('click', reInvest);
    resetBtn.addEventListener('click', () => {
      if (confirm('Reset balance to 1000?')) resetBalance();
    });

    // Initialize
    updateDisplay();
    drawCandles();
    const interval = setInterval(updateGraph, UPDATE_MS);

    // Make canvas responsive on resize
    function resizeCanvas() {
      // keep CSS size but update internal resolution for crispness
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.round(rect.width * devicePixelRatio);
      canvas.height = Math.round(rect.height * devicePixelRatio);
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      drawCandles();
    }
    // initial resize (canvas has width/height attributes but ensure devicePixelRatio)
    window.addEventListener('resize', resizeCanvas);
    // call once to set proper resolution
    resizeCanvas();
  </script>
</body>
</html>
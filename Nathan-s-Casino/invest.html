<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Candle Market Simulator</title>

<!-- Correct favicon -->
<link rel="icon" type="image/png" href="../icon.png">

<style>
  body {
    background:#0b1220;
    color:#f9fafb;
    font-family:Arial, sans-serif;
    display:flex;
    justify-content:center;
    padding-top:60px;
  }

  /* Back button */
  .back-btn {
    position:fixed;
    top:10px;
    left:10px;
    width:40px;
    height:40px;
    background-image:url('../icon.png');
    background-size:contain;
    background-repeat:no-repeat;
    background-position:center;
    cursor:pointer;
    z-index:9999;
  }

  .app {
    background:#020617;
    padding:20px;
    border-radius:10px;
    width:900px;
    box-shadow:0 0 20px rgba(0,0,0,0.6);
  }

  h1 {
    text-align:center;
    margin-top:0;
  }

  .top {
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:10px;
  }

  .balance {
    font-size:1.1em;
  }

  .controls {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }

  input {
    background:#0b1220;
    border:1px solid #334155;
    color:white;
    padding:6px;
    border-radius:6px;
    width:100px;
  }

  button {
    background:#4ecca3;
    border:none;
    padding:8px 14px;
    border-radius:6px;
    font-weight:bold;
    cursor:pointer;
    color:#022c22;
  }

  button.sell {
    background:#f97316;
    color:#451a03;
  }

  canvas {
    width:100%;
    background:#020617;
    border-radius:6px;
  }

  .info {
    margin-top:10px;
    font-size:0.9em;
  }

  .status {
    margin-top:10px;
    min-height:20px;
  }
</style>
</head>
<body>

<a class="back-btn" href="../launch-deck.html"></a>

<div class="app">
  <h1>Candle Market Simulator</h1>

  <div class="top">
    <div class="balance">Balance: $<span id="balance">0</span></div>
    <div>
      Shares: <span id="shares">0</span> |
      Avg Cost: $<span id="avgCost">0</span> |
      Unrealized: $<span id="unrealized">0</span>
    </div>
  </div>

  <div class="controls">
    <div>Price: $<span id="price">0</span></div>
    <input type="number" id="qty" value="10" min="1">
    <button id="buyBtn">Buy</button>
    <button id="sellBtn" class="sell">Sell</button>
    <button id="nextBtn">Next Candle</button>
  </div>

  <canvas id="chart" width="900" height="300"></canvas>

  <div class="info">
    O: <span id="oVal">0</span> |
    H: <span id="hVal">0</span> |
    L: <span id="lVal">0</span> |
    C: <span id="cVal">0</span>
  </div>

  <div class="status" id="status"></div>
</div>

<script>
// ---------------- COOKIE HELPERS ----------------
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/";
}

function getCookie(name) {
  const cname = name + "=";
  const arr = decodeURIComponent(document.cookie).split(";");
  for (let c of arr) {
    c = c.trim();
    if (c.indexOf(cname) === 0) return c.substring(cname.length);
  }
  return null;
}

// ---------------- STATE ----------------
let balance = 0;
let candles = [];
let currentPrice = 100;
let shares = 0;
let avgCost = 0;

const balanceSpan = document.getElementById("balance");
const priceSpan = document.getElementById("price");
const sharesSpan = document.getElementById("shares");
const avgCostSpan = document.getElementById("avgCost");
const unrealizedSpan = document.getElementById("unrealized");
const statusDiv = document.getElementById("status");

const oVal = document.getElementById("oVal");
const hVal = document.getElementById("hVal");
const lVal = document.getElementById("lVal");
const cVal = document.getElementById("cVal");

const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");

// ---------------- BALANCE ----------------
function initBalance() {
  const stored = getCookie("balance");
  balance = stored && !isNaN(stored) ? parseInt(stored) : 1000;
  saveBalance();
}

function saveBalance() {
  setCookie("balance", balance, 365);
  balanceSpan.textContent = balance.toFixed(2);
}

// ---------------- CANDLE GENERATION ----------------
function randomCandle(prevClose) {
  const vol = 1.5;
  const open = prevClose;
  const move = (Math.random() - 0.5) * vol * 2;
  const close = Math.max(1, open + move);

  const high = Math.max(open, close) + Math.random() * vol;
  const low = Math.max(1, Math.min(open, close) - Math.random() * vol);

  return {
    o: open.toFixed(2),
    h: high.toFixed(2),
    l: low.toFixed(2),
    c: close.toFixed(2)
  };
}

function stepCandle() {
  const prev = candles.length ? parseFloat(candles[candles.length - 1].c) : currentPrice;
  const c = randomCandle(prev);
  candles.push(c);
  currentPrice = parseFloat(c.c);

  updateCandleInfo(c);
  updatePrice();
  updateUnrealized();
  drawChart();
}

function updateCandleInfo(c) {
  oVal.textContent = c.o;
  hVal.textContent = c.h;
  lVal.textContent = c.l;
  cVal.textContent = c.c;
}

function updatePrice() {
  priceSpan.textContent = currentPrice.toFixed(2);
}

// ---------------- CHART ----------------
function drawChart() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!candles.length) return;

  const padding = 20;
  const w = canvas.width;
  const h = canvas.height;

  const lows = candles.map(c => parseFloat(c.l));
  const highs = candles.map(c => parseFloat(c.h));

  const minPrice = Math.min(...lows);
  const maxPrice = Math.max(...highs);
  const range = maxPrice - minPrice || 1;

  const candleWidth = Math.max(6, (w - padding * 2) / candles.length);

  candles.forEach((c, i) => {
    const open = parseFloat(c.o);
    const close = parseFloat(c.c);
    const high = parseFloat(c.h);
    const low = parseFloat(c.l);

    const x = padding + i * candleWidth + candleWidth / 2;

    const yHigh = map(high);
    const yLow = map(low);
    const yOpen = map(open);
    const yClose = map(close);

    const color = close >= open ? "#22c55e" : "#ef4444";

    // wick
    ctx.strokeStyle = color;
    ctx.beginPath();
    ctx.moveTo(x, yHigh);
    ctx.lineTo(x, yLow);
    ctx.stroke();

    // body
    const top = Math.min(yOpen, yClose);
    const bottom = Math.max(yOpen, yClose);
    ctx.fillStyle = color;
    ctx.fillRect(x - candleWidth / 2 + 1, top, candleWidth - 2, bottom - top);
  });

  function map(price) {
    return h - padding - ((price - minPrice) / range) * (h - padding * 2);
  }
}

// ---------------- TRADING ----------------
function updateUnrealized() {
  const unreal = shares * (currentPrice - avgCost);
  unrealizedSpan.textContent = unreal.toFixed(2);
}

function buy() {
  const qty = parseInt(document.getElementById("qty").value);
  if (!qty || qty <= 0) return;

  const cost = qty * currentPrice;
  if (cost > balance) {
    statusDiv.textContent = "Not enough balance.";
    return;
  }

  balance -= cost;

  const totalBefore = shares * avgCost;
  shares += qty;
  avgCost = (totalBefore + cost) / shares;

  saveBalance();
  updatePosition();
  statusDiv.textContent = `Bought ${qty} @ $${currentPrice.toFixed(2)}`;
}

function sell() {
  const qty = parseInt(document.getElementById("qty").value);
  if (!qty || qty <= 0) return;

  if (qty > shares) {
    statusDiv.textContent = "Not enough shares.";
    return;
  }

  const revenue = qty * currentPrice;
  balance += revenue;

  shares -= qty;
  if (shares === 0) avgCost = 0;

  saveBalance();
  updatePosition();
  statusDiv.textContent = `Sold ${qty} @ $${currentPrice.toFixed(2)}`;
}

function updatePosition() {
  sharesSpan.textContent = shares;
  avgCostSpan.textContent = avgCost.toFixed(2);
  updateUnrealized();
}

// ---------------- EVENTS ----------------
document.getElementById("buyBtn").onclick = buy;
document.getElementById("sellBtn").onclick = sell;
document.getElementById("nextBtn").onclick = stepCandle;

// ---------------- INIT ----------------
initBalance();
stepCandle();
</script>

</body>
</html>

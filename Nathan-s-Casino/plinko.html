<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Plinko</title>
<link rel="icon" type="image/png" href="../icon.png">

<style>
  body {
    background:#0f0f1a;
    color:white;
    font-family:Arial;
    display:flex;
    justify-content:center;
    padding-top:60px;
  }

  .back-btn {
    position:fixed;
    top:10px;
    left:10px;
    width:40px;
    height:40px;
    background-image:url('../icon.png');
    background-size:contain;
    background-repeat:no-repeat;
    background-position:center;
    cursor:pointer;
    z-index:9999;
  }

  .game {
    background:#1a1a2e;
    padding:20px;
    border-radius:12px;
    width:420px;
    text-align:center;
    box-shadow:0 0 20px rgba(0,0,0,0.5);
  }

  canvas {
    background:#0b0b16;
    border-radius:10px;
    margin-top:20px;
  }

  input {
    width:140px;
    padding:8px;
    margin:6px;
    border-radius:6px;
    border:none;
    background:#0f0f1a;
    color:white;
    font-size:16px;
  }

  button {
    width:200px;
    padding:12px;
    background:#4ecca3;
    border:none;
    border-radius:10px;
    font-size:20px;
    font-weight:bold;
    cursor:pointer;
    margin-top:10px;
    transition:0.15s;
  }

  button:active {
    transform:scale(0.97);
    background:#3ba987;
  }

  #result {
    margin-top:20px;
    font-size:22px;
    min-height:30px;
  }
</style>
</head>
<body>

<a class="back-btn" href="../launch-deck.html"></a>

<div class="game">
  <h1>Plinko</h1>

  <div>Balance: $<span id="balance">0</span></div>

  <input type="number" id="bet" placeholder="Bet" min="1">
  <button id="dropBtn">DROP</button>

  <canvas id="board" width="400" height="500"></canvas>

  <div id="result"></div>
</div>

<script>
/* ---------------- COOKIE HELPERS ---------------- */
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;
}

function getCookie(name) {
  const cname = name + "=";
  const arr = decodeURIComponent(document.cookie).split(";");
  for (let c of arr) {
    c = c.trim();
    if (c.indexOf(cname) === 0) return c.substring(cname.length);
  }
  return null;
}

/* ---------------- BALANCE ---------------- */
let balance = 0;

function loadBalance() {
  const stored = getCookie("balance");
  balance = stored && !isNaN(stored) ? parseInt(stored) : 0;
  updateBalance();
}

function updateBalance() {
  document.getElementById("balance").textContent = balance;
}

function saveBalance() {
  setCookie("balance", balance, 365);
  updateBalance();
}

/* ---------------- PLINKO BOARD ---------------- */
const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d");

const pegs = [];
const rows = 10;
const spacing = 35;

for (let r = 0; r < rows; r++) {
  for (let c = 0; c <= r; c++) {
    pegs.push({
      x: canvas.width/2 - (r * spacing)/2 + c * spacing,
      y: 60 + r * spacing
    });
  }
}

const slots = [
  0.1, 0.5, 1, 3, 5, 3, 1, 0.5, 0.1
];

let ball = null;

/* ---------------- BALL PHYSICS ---------------- */
function dropBall() {
  ball = {
    x: canvas.width/2,
    y: 20,
    vx: 0,
    vy: 2
  };
}

function updateBall() {
  if (!ball) return;

  ball.vy += 0.15;
  ball.x += ball.vx;
  ball.y += ball.vy;

  // collisions with pegs
  for (let p of pegs) {
    const dx = ball.x - p.x;
    const dy = ball.y - p.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if (dist < 10) {
      ball.vy *= -0.4;
      ball.vx += (Math.random() - 0.5) * 2;
    }
  }

  // bottom reached
  if (ball.y > canvas.height - 30) {
    const slotWidth = canvas.width / slots.length;
    const index = Math.floor(ball.x / slotWidth);
    finishDrop(index);
    ball = null;
  }
}

function drawBoard() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // draw pegs
  ctx.fillStyle = "#4ecca3";
  for (let p of pegs) {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
    ctx.fill();
  }

  // draw slots
  const slotWidth = canvas.width / slots.length;
  for (let i = 0; i < slots.length; i++) {
    ctx.fillStyle = "#222";
    ctx.fillRect(i*slotWidth, canvas.height-30, slotWidth-2, 30);

    ctx.fillStyle = "white";
    ctx.font = "12px Arial";
    ctx.fillText(slots[i] + "x", i*slotWidth + slotWidth/2 - 10, canvas.height - 10);
  }

  // draw ball
  if (ball) {
    ctx.fillStyle = "yellow";
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, 8, 0, Math.PI*2);
    ctx.fill();
  }
}

function loop() {
  updateBall();
  drawBoard();
  requestAnimationFrame(loop);
}

loop();

/* ---------------- GAME LOGIC ---------------- */
document.getElementById("dropBtn").onclick = () => {
  const bet = parseFloat(document.getElementById("bet").value);
  const resultDiv = document.getElementById("result");

  if (!bet || bet <= 0) {
    resultDiv.textContent = "Enter a valid bet.";
    return;
  }
  if (bet > balance) {
    resultDiv.textContent = "Not enough balance.";
    return;
  }

  balance -= bet;
  saveBalance();

  resultDiv.textContent = "Dropping...";

  dropBall();
};

function finishDrop(slotIndex) {
  const mult = slots[slotIndex] || 0.1;
  const bet = parseFloat(document.getElementById("bet").value);
  const win = bet * mult;

  balance += win;
  saveBalance();

  document.getElementById("result").textContent =
    `Landed on ${mult}x â€” You won $${win.toFixed(2)}`;
}

/* ---------------- INIT ---------------- */
loadBalance();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Advanced Variable Calculator</title>
<link rel="icon" type="image/png" href="../icon.png" />
<style>
  :root{
    --bg:#121212;
    --panel: rgba(10,10,10,0.6);
    --accent:#0a84ff;
    --btn:#333;
    --text:#ffffff;
    --muted:#bdbdbd;
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background-size:cover;background-position:center}
  .container{width:920px;max-width:calc(100% - 40px);display:grid;grid-template-columns:1fr 260px;gap:16px;background:var(--panel);border-radius:12px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .left{display:flex;flex-direction:column;gap:12px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .title{font-weight:700;font-size:18px}
  .controls{display:flex;gap:8px;align-items:center}
  .typed-input{width:100%;padding:10px;border-radius:8px;border:none;background:#0f0f0f;color:var(--text);font-size:15px}
  .display-wrap{background:#000;border-radius:8px;padding:10px;color:var(--accent);min-height:72px;display:flex;flex-direction:column;justify-content:center}
  .secondary{color:var(--muted);font-size:13px;text-align:right;min-height:18px}
  .display{font-size:28px;text-align:right;white-space:nowrap;overflow:auto}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  button{padding:12px;border-radius:8px;border:none;background:var(--btn);color:var(--text);font-size:14px;cursor:pointer;transition:transform .06s,filter .08s}
  button:active{transform:translateY(1px)}
  .op{background:#ff9500;color:#fff}
  .eq{background:var(--accent);color:#fff;grid-column:span 2}
  .wide{grid-column:span 2}
  .muted{background:#555}
  .memory{background:#2b2b2b}
  .func{background:#3a3a3a}
  .right{display:flex;flex-direction:column;gap:12px}
  .panel{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;min-height:80px}
  .history{max-height:420px;overflow:auto;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02)}
  .history-item{padding:6px;border-radius:6px;cursor:pointer;font-size:13px}
  .history-item:hover{background:rgba(255,255,255,0.03)}
  .vars{max-height:220px;overflow:auto;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02)}
  .var-item{padding:6px;border-radius:6px;cursor:pointer;font-size:13px;display:flex;justify-content:space-between;gap:8px}
  .var-item:hover{background:rgba(255,255,255,0.03)}
  .settings-btn{background:#444;padding:8px;border-radius:8px;color:#fff;border:none;cursor:pointer}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#111;padding:16px;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.7);display:none;z-index:50;width:360px;color:#fff}
  .modal label{font-size:13px;color:var(--muted)}
  .modal input[type="color"], .modal input[type="text"]{width:100%;padding:8px;margin:6px 0 12px;border-radius:6px;border:none}
  .small{font-size:12px;color:var(--muted)}
  @media (max-width:980px){
    .container{grid-template-columns:1fr}
    .eq{grid-column:span 3}
    .wide{grid-column:span 3}
  }
</style>
</head>
<body>
  <a href="../launch-deck.html" style="position: fixed; top: 12px; left: 12px; z-index: 100;">
    <img src="../icon.png" alt="" style="height: 60px; background: black; border-radius: 4px;">
  </a>
<div class="app" id="app">
  <div class="container">
    <div class="left">
      <div class="topbar">
        <div class="title">Advanced Variable Calculator</div>
        <div class="controls">
          <button class="settings-btn" id="openSettings">⚙️ Appearance</button>
          <button class="settings-btn" id="clearBtn">Space = Clear</button>
        </div>
      </div>

      <input id="typedInput" class="typed-input" placeholder="Type expression or assignment, e.g. speed = 2*x  — press Enter to evaluate" autocomplete="off" />

      <div class="display-wrap">
        <div class="secondary" id="secondary"></div>
        <div class="display" id="display">0</div>
      </div>

      <div class="grid" id="buttons">
        <!-- Memory row -->
        <button class="memory" data-action="MC">MC</button>
        <button class="memory" data-action="MR">MR</button>
        <button class="memory" data-action="MS">MS</button>
        <button class="memory" data-action="M+">M+</button>
        <button class="memory" data-action="M-">M-</button>
        <button class="func" data-action="C">C</button>

        <!-- Row 2 -->
        <button class="func" data-action="CE">CE</button>
        <button class="func" data-action="back">⌫</button>
        <button class="func" data-action="percent">%</button>
        <button class="func" data-action="sqrt">√</button>
        <button class="func" data-action="recip">1/x</button>
        <button class="op" data-op="/">÷</button>

        <!-- Row 3 -->
        <button data-num="7">7</button>
        <button data-num="8">8</button>
        <button data-num="9">9</button>
        <button class="func" data-action="pow">^</button>
        <button class="func" data-action="fact">!</button>
        <button class="op" data-op="*">×</button>

        <!-- Row 4 -->
        <button data-num="4">4</button>
        <button data-num="5">5</button>
        <button data-num="6">6</button>
        <button class="func" data-action="sin">sin</button>
        <button class="func" data-action="cos">cos</button>
        <button class="op" data-op="-">−</button>

        <!-- Row 5 -->
        <button data-num="1">1</button>
        <button data-num="2">2</button>
        <button data-num="3">3</button>
        <button class="func" data-action="tan">tan</button>
        <button class="func" data-action="ln">ln</button>
        <button class="op" data-op="+">+</button>

        <!-- Row 6 -->
        <button class="wide" data-num="0">0</button>
        <button data-num=".">.</button>
        <button class="func" data-action="neg">±</button>
        <button class="eq" data-action="equals">=</button>

        <!-- Extra row -->
        <button class="func" data-action="(">(</button>
        <button class="func" data-action=")">)</button>
        <button class="func" data-action="log10">log10</button>
        <button class="func" data-action="asin">asin</button>
        <button class="func" data-action="acos">acos</button>
        <button class="func" data-action="atan">atan</button>

        <button class="func" data-action="exp">exp</button>
        <button class="func" data-action="pi">π</button>
        <button class="func" data-action="e">e</button>
        <button class="func" data-action="ans">ANS</button>
        <button class="func" data-action="percent2">x%</button>
        <button class="muted" data-action="historyToggle">History</button>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:600">Session History</div>
          <div class="small">Click to reuse</div>
        </div>
        <div class="history" id="historyList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="settings-btn" id="copyResult">Copy Result</button>
          <button class="settings-btn" id="clearHistory">Clear History</button>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:600">Stored Variables (cookie)</div>
          <div class="small">Click to insert or delete</div>
        </div>
        <div class="vars" id="varsList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="settings-btn" id="exportVars">Export</button>
          <button class="settings-btn" id="clearVars">Clear Vars</button>
        </div>
      </div>

      <div class="panel small">
        <div><strong>Tips</strong></div>
        <ul style="margin:6px 0 0 18px;padding:0">
          <li>Type `name = expression` to store (e.g., <code>speed = 2*x</code>).</li>
          <li>Type `name =` to inspect stored expression (returns the expression, not evaluated).</li>
          <li>Enter evaluates typed expression; Space clears; Backspace edits.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal" id="modal">
  <h3>Appearance</h3>
  <label>Background color</label>
  <input type="color" id="bgColor" value="#121212">
  <label>Background image URL (optional)</label>
  <input type="text" id="bgImage" placeholder="https://...">
  <label>Panel color (semi-transparent)</label>
  <input type="color" id="panelColor" value="#000000">
  <label>Accent color</label>
  <input type="color" id="accentColor" value="#0a84ff">
  <label>Button color</label>
  <input type="color" id="buttonColor" value="#333333">
  <div style="display:flex;gap:8px;margin-top:8px">
    <button class="save settings-btn" id="saveSettings">Save</button>
    <button class="close settings-btn" id="closeModal">Close</button>
  </div>
</div>

<script>
/* ---------------- State ---------------- */
const typedInput = document.getElementById('typedInput');
const displayEl = document.getElementById('display');
const secondaryEl = document.getElementById('secondary');
const historyListEl = document.getElementById('historyList');
const varsListEl = document.getElementById('varsList');
const app = document.getElementById('app');

let history = []; // session-only
let variables = loadVarsFromCookie(); // persisted in cookie
let memory = 0;
let lastAnswer = null;
let justCalculated = false;

/* ---------------- Cookie helpers ---------------- */
function loadVarsFromCookie(){
  const name = 'calcVars=';
  const parts = document.cookie.split(';');
  for(const part of parts){
    const p = part.trim();
    if(p.startsWith(name)){
      try{
        return JSON.parse(decodeURIComponent(p.substring(name.length))) || {};
      }catch(e){ return {}; }
    }
  }
  return {};
}
function saveVarsToCookie(){
  const value = encodeURIComponent(JSON.stringify(variables));
  document.cookie = 'calcVars=' + value + ';path=/;max-age=31536000';
}
function clearVarsCookie(){
  variables = {};
  document.cookie = 'calcVars=;path=/;max-age=0';
}

/* ---------------- UI helpers ---------------- */
function setDisplay(v){ displayEl.textContent = String(v); }
function setSecondary(t){ secondaryEl.textContent = t || ''; }
function addHistory(line){
  history.unshift(line);
  if(history.length>300) history.pop();
  renderHistory();
}
function renderHistory(){
  historyListEl.innerHTML = '';
  history.forEach(h=>{
    const div = document.createElement('div');
    div.className = 'history-item';
    div.textContent = h;
    div.onclick = ()=> {
      typedInput.value = h.split(' = ')[0];
      typedInput.focus();
    };
    historyListEl.appendChild(div);
  });
}
function renderVars(){
  varsListEl.innerHTML = '';
  const keys = Object.keys(variables).sort();
  if(keys.length === 0){
    varsListEl.innerHTML = '<div class="small">No stored variables</div>';
    return;
  }
  keys.forEach(k=>{
    const div = document.createElement('div');
    div.className = 'var-item';
    const left = document.createElement('div');
    left.textContent = k + ' = ' + variables[k];
    left.style.flex = '1';
    left.style.overflow = 'hidden';
    left.style.textOverflow = 'ellipsis';
    left.style.whiteSpace = 'nowrap';
    const right = document.createElement('div');
    right.style.display = 'flex';
    right.style.gap = '6px';
    const insertBtn = document.createElement('button');
    insertBtn.textContent = 'Insert';
    insertBtn.className = 'settings-btn';
    insertBtn.style.padding = '4px 6px';
    insertBtn.onclick = ()=> {
      typedInput.value += k;
      typedInput.focus();
    };
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Delete';
    delBtn.className = 'settings-btn';
    delBtn.style.padding = '4px 6px';
    delBtn.onclick = ()=> {
      delete variables[k];
      saveVarsToCookie();
      renderVars();
    };
    right.appendChild(insertBtn);
    right.appendChild(delBtn);
    div.appendChild(left);
    div.appendChild(right);
    varsListEl.appendChild(div);
  });
}

/* ---------------- Parsing & normalization ---------------- */
function normalizeInput(s){
  if(!s) return '';
  let t = s.trim();
  t = t.replace(/×/g,'*').replace(/÷/g,'/').replace(/–/g,'-').replace(/−/g,'-');
  t = t.replace(/\^/g,'**');
  return t;
}

/* Token replacement for variables: returns expression with variables substituted (parenthesized) */
function substituteVars(expr){
  // Replace variable names with their stored expressions in parentheses
  // Use word boundary to avoid partial matches
  return expr.replace(/\b[a-zA-Z_][a-zA-Z0-9_]*\b/g, name=>{
    if(name === 'pi' || name === 'e') return name; // keep constants
    if(name in variables){
      return '(' + variables[name] + ')';
    }
    return name; // leave undefined variable as symbol
  });
}

/* Detect if expression contains any letter variables (excluding pi/e) */
function containsSymbol(expr){
  return /\b(?!pi\b|e\b)[a-zA-Z_][a-zA-Z0-9_]*\b/.test(expr);
}

/* Basic symbolic pretty printer and simplifier:
   - collapse numeric multipliers with variables (e.g., 2*(x) -> 2x)
   - collapse repeated variable multiplications into powers (x*x -> x^2)
   - show dot between different symbols (a*b -> a·b)
   This is intentionally lightweight but handles common cases.
*/
function symbolicSimplify(expr){
  let s = expr;

  // remove outer parentheses where safe
  s = s.replace(/^\((.*)\)$/, '$1');

  // replace numeric * (var) -> numeric var
  s = s.replace(/(\d+(?:\.\d+)?)\s*\*\s*\(([a-zA-Z_][a-zA-Z0-9_]*(?:\*[a-zA-Z_][a-zA-Z0-9_]*)*)\)/g, (m, n, vars)=>{
    return n + '*' + vars;
  });

  // collapse var * var -> var·var (then later collapse repeated)
  s = s.replace(/([a-zA-Z_][a-zA-Z0-9_]*)\s*\*\s*([a-zA-Z_][a-zA-Z0-9_]*)/g, '$1·$2');

  // collapse numeric * var -> 2x (remove star)
  s = s.replace(/(\d+(?:\.\d+)?)\s*\*\s*([a-zA-Z_][a-zA-Z0-9_]*)/g, '$1$2');

  // collapse var * numeric -> 2x
  s = s.replace(/([a-zA-Z_][a-zA-Z0-9_]*)\s*\*\s*(\d+(?:\.\d+)?)/g, '$2$1');

  // collapse repeated var multiplications into powers: x·x·x -> x^3
  s = s.replace(/([a-zA-Z_][a-zA-Z0-9_]*)(?:·\1)+/g, (m)=>{
    const parts = m.split('·');
    const name = parts[0];
    return name + '^' + parts.length;
  });

  // collapse numeric multipliers: 2*3*x -> 6x
  s = s.replace(/(\d+(?:\.\d+)?)\s*\*\s*(\d+(?:\.\d+)?)/g, (m,a,b)=> String(parseFloat(a)*parseFloat(b)));

  // tidy up ** to ^ for display
  s = s.replace(/\*\*/g,'^');

  // remove unnecessary parentheses around single tokens
  s = s.replace(/\((\w+)\)/g,'$1');

  return s;
}

/* Evaluate expression safely when possible */
function evaluateExpression(raw){
  const normalized = normalizeInput(raw);
  const substituted = substituteVars(normalized);

  // If substituted still contains variable names (excluding pi/e), treat as symbolic
  if(containsSymbol(substituted)){
    // produce symbolic simplified string
    const pretty = symbolicSimplify(substituted);
    return { type: 'symbolic', value: pretty };
  }

  // Replace pi and e tokens with Math constants
  const jsExpr = substituted.replace(/\bpi\b/g, 'Math.PI').replace(/\be\b/g, 'Math.E');

  // Provide Math functions in scope by building a wrapper
  const wrapper = `
    const sin = Math.sin, cos = Math.cos, tan = Math.tan,
          asin = Math.asin, acos = Math.acos, atan = Math.atan,
          sqrt = Math.sqrt, ln = Math.log, log10 = Math.log10 || ((x)=>Math.log(x)/Math.LN10),
          exp = Math.exp, abs = Math.abs, pow = Math.pow;
    return (${jsExpr});
  `;
  try{
    const fn = new Function(wrapper);
    const val = fn();
    if(typeof val === 'number' && isFinite(val)){
      return { type: 'number', value: val };
    } else {
      return { type: 'error', value: 'Error' };
    }
  }catch(e){
    return { type: 'error', value: 'Error' };
  }
}

/* ---------------- Main input handling ---------------- */
function handleEnter(){
  const raw = typedInput.value.trim();
  if(raw === '') return;

  // Inspect assignment: name =
  const inspectMatch = raw.match(/^([a-zA-Z_][a-zA-Z0-9_]*)\s*=$/);
  if(inspectMatch){
    const name = inspectMatch[1];
    if(name in variables){
      setSecondary(name + ' =');
      setDisplay(variables[name]);
      addHistory(name + ' = ' + variables[name]);
    } else {
      setSecondary('');
      setDisplay(name + ' is undefined');
    }
    typedInput.focus();
    return;
  }

  // Assignment: name = expr
  const assignMatch = raw.match(/^([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*(.+)$/);
  if(assignMatch){
    const name = assignMatch[1];
    const rhs = assignMatch[2].trim();
    if(rhs === ''){
      // treat as inspect
      if(name in variables){
        setSecondary(name + ' =');
        setDisplay(variables[name]);
        addHistory(name + ' = ' + variables[name]);
      } else {
        setSecondary('');
        setDisplay(name + ' is undefined');
      }
      typedInput.focus();
      return;
    }
    // store normalized RHS as string (so inspection returns original-like expression)
    variables[name] = normalizeInput(rhs);
    saveVarsToCookie();
    setSecondary('stored: ' + name);
    setDisplay(variables[name]);
    addHistory(name + ' = ' + variables[name]);
    typedInput.value = '';
    typedInput.focus();
    return;
  }

  // Plain expression: evaluate
  const result = evaluateExpression(raw);
  setSecondary(raw);
  if(result.type === 'number'){
    setDisplay(result.value);
    lastAnswer = result.value;
    justCalculated = true;
    addHistory(raw + ' = ' + result.value);
    typedInput.value = String(result.value);
  } else if(result.type === 'symbolic'){
    setDisplay(result.value);
    lastAnswer = null;
    justCalculated = true;
    addHistory(raw + ' = ' + result.value);
    typedInput.value = result.value;
  } else {
    setDisplay('Error');
    lastAnswer = null;
  }
  typedInput.focus();
}

/* ---------------- Unary & function handlers ---------------- */
function applyUnary(action){
  const target = typedInput.value.trim() || displayEl.textContent;
  if(target === '') return;
  // If target is a variable name and action is inspect-like, handle separately
  // Evaluate or symbolically transform
  if(action === 'neg'){
    // if numeric, negate; if symbolic, prefix with -
    const evalRes = evaluateExpression(target);
    if(evalRes.type === 'number'){
      typedInput.value = String(-evalRes.value);
      setDisplay(-evalRes.value);
      addHistory('neg ' + target + ' = ' + (-evalRes.value));
    } else if(evalRes.type === 'symbolic'){
      typedInput.value = '-(' + evalRes.value + ')';
      setDisplay('-(' + evalRes.value + ')');
      addHistory('neg ' + target + ' = ' + typedInput.value);
    }
    return;
  }

  // For other unary functions, attempt numeric evaluation first, else symbolic wrapper
  const normalized = normalizeInput(target);
  const substituted = substituteVars(normalized);
  const jsName = {
    'sqrt':'sqrt','recip':'1/','percent':'/100','fact':'fact','pi':'pi','e':'e'
  }[action] || action;

  // handle percent2 (x% of previous) separately
  if(action === 'percent2'){
    // if previous variable exists in typedInput context, try to compute base * (value/100)
    // fallback: treat as value/100
    const valRes = evaluateExpression(target);
    if(valRes.type === 'number'){
      typedInput.value = String(valRes.value / 100);
      setDisplay(typedInput.value);
      addHistory(target + '% = ' + typedInput.value);
    } else {
      typedInput.value = '(' + target + ')/100';
      setDisplay(typedInput.value);
      addHistory(target + '% = ' + typedInput.value);
    }
    return;
  }

  // factorial
  if(action === 'fact'){
    const res = evaluateExpression(target);
    if(res.type === 'number' && Number.isInteger(res.value) && res.value >= 0){
      let f = 1;
      for(let i=2;i<=res.value;i++) f *= i;
      typedInput.value = String(f);
      setDisplay(f);
      addHistory('fact ' + target + ' = ' + f);
    } else {
      setDisplay('Error');
    }
    return;
  }

  // recip
  if(action === 'recip'){
    const res = evaluateExpression(target);
    if(res.type === 'number' && res.value !== 0){
      typedInput.value = String(1 / res.value);
      setDisplay(typedInput.value);
      addHistory('1/(' + target + ') = ' + typedInput.value);
    } else if(res.type === 'symbolic'){
      typedInput.value = '1/(' + res.value + ')';
      setDisplay(typedInput.value);
      addHistory('1/(' + res.value + ')');
    } else {
      setDisplay('Error');
    }
    return;
  }

  // pi and e insertion
  if(action === 'pi'){ typedInput.value += 'pi'; typedInput.focus(); return; }
  if(action === 'e'){ typedInput.value += 'e'; typedInput.focus(); return; }

  // trig/log functions
  if(['sin','cos','tan','asin','acos','atan','ln','log10','exp','sqrt'].includes(action)){
    // if numeric, compute; if symbolic, wrap function
    const res = evaluateExpression(target);
    if(res.type === 'number'){
      let out;
      try{
        switch(action){
          case 'sin': out = Math.sin(res.value); break;
          case 'cos': out = Math.cos(res.value); break;
          case 'tan': out = Math.tan(res.value); break;
          case 'asin': out = Math.asin(res.value); break;
          case 'acos': out = Math.acos(res.value); break;
          case 'atan': out = Math.atan(res.value); break;
          case 'ln': out = Math.log(res.value); break;
          case 'log10': out = Math.log10 ? Math.log10(res.value) : Math.log(res.value)/Math.LN10; break;
          case 'exp': out = Math.exp(res.value); break;
          case 'sqrt': out = Math.sqrt(res.value); break;
        }
        typedInput.value = String(out);
        setDisplay(out);
        addHistory(action + '(' + target + ') = ' + out);
      }catch(e){
        setDisplay('Error');
      }
    } else if(res.type === 'symbolic'){
      typedInput.value = action + '(' + res.value + ')';
      setDisplay(typedInput.value);
      addHistory(action + '(' + res.value + ')');
    } else {
      setDisplay('Error');
    }
    return;
  }
}

/* ---------------- Operator & button wiring ---------------- */
document.querySelectorAll('button').forEach(btn=>{
  const num = btn.dataset.num;
  const op = btn.dataset.op;
  const action = btn.dataset.action;

  if(num !== undefined){
    btn.addEventListener('click', ()=> {
      typedInput.value += num;
      typedInput.focus();
    });
  } else if(op !== undefined){
    btn.addEventListener('click', ()=> {
      // clicking operator locks current typed value as previous if appropriate
      // If typedInput has content, and it's not an assignment, we keep it and append operator
      // If typedInput empty, append operator to current display
      if(typedInput.value.trim() === ''){
        typedInput.value = displayEl.textContent;
      }
      typedInput.value += op;
      typedInput.focus();
    });
  } else if(action){
    btn.addEventListener('click', ()=> {
      if(action === 'equals'){
        handleEnter();
      } else if(action === 'back'){
        typedInput.value = typedInput.value.slice(0,-1);
        typedInput.focus();
      } else if(action === '(' || action === ')'){
        typedInput.value += action;
        typedInput.focus();
      } else if(action === 'C'){
        typedInput.value = '';
        setSecondary('');
        setDisplay('0');
        typedInput.focus();
      } else if(action === 'MC'){
        memory = 0;
      } else if(action === 'MR'){
        typedInput.value += String(memory);
        typedInput.focus();
      } else if(action === 'MS'){
        const res = evaluateExpression(typedInput.value || displayEl.textContent);
        if(res.type === 'number') memory = res.value;
      } else if(action === 'M+'){
        const res = evaluateExpression(typedInput.value || displayEl.textContent);
        if(res.type === 'number') memory += res.value;
      } else if(action === 'M-'){
        const res = evaluateExpression(typedInput.value || displayEl.textContent);
        if(res.type === 'number') memory -= res.value;
      } else if(action === 'neg' || action === 'sqrt' || action === 'recip' || action === 'percent' || action === 'percent2' || action === 'fact' || action === 'pi' || action === 'e'){
        applyUnary(action);
      } else if(['sin','cos','tan','asin','acos','atan','ln','log10','exp'].includes(action)){
        applyUnary(action);
      } else if(action === 'ans'){
        if(lastAnswer !== null) typedInput.value += String(lastAnswer);
        typedInput.focus();
      } else if(action === 'historyToggle'){
        // focus history (no-op)
      }
    });
  }
});

/* ---------------- Keyboard support ---------------- */
document.addEventListener('keydown', (e)=>{
  const key = e.key;
  // If typedInput is focused, let typing behave normally; Enter will evaluate
  if(document.activeElement === typedInput){
    if(key === 'Enter'){ e.preventDefault(); handleEnter(); }
    return;
  }

  // Global shortcuts when input not focused
  if(key === ' '){ e.preventDefault(); typedInput.value = ''; setSecondary(''); setDisplay('0'); typedInput.focus(); return; }
  if(!isNaN(key)){ typedInput.value += key; typedInput.focus(); return; }
  if(key === '.') { typedInput.value += '.'; typedInput.focus(); return; }
  if(['+','-','*','/','^'].includes(key)){ typedInput.value += key; typedInput.focus(); return; }
  if(key === 'Enter' || key === '='){ e.preventDefault(); handleEnter(); return; }
  if(key === 'Backspace'){ typedInput.value = typedInput.value.slice(0,-1); typedInput.focus(); return; }
  if(key === '(' || key === ')'){ typedInput.value += key; typedInput.focus(); return; }
  // quick function keys
  if(key.toLowerCase() === 's'){ typedInput.value += 'sin('; typedInput.focus(); return; }
  if(key.toLowerCase() === 'c'){ typedInput.value += 'cos('; typedInput.focus(); return; }
  if(key.toLowerCase() === 't'){ typedInput.value += 'tan('; typedInput.focus(); return; }
});

/* ---------------- History & vars controls ---------------- */
document.getElementById('copyResult').addEventListener('click', ()=>{
  navigator.clipboard?.writeText(displayEl.textContent).then(()=>{}, ()=>{});
});
document.getElementById('clearHistory').addEventListener('click', ()=>{
  history = [];
  renderHistory();
});
document.getElementById('exportVars').addEventListener('click', ()=>{
  const data = JSON.stringify(variables, null, 2);
  // show in prompt for quick copy
  prompt('Variables JSON (copy to clipboard):', data);
});
document.getElementById('clearVars').addEventListener('click', ()=>{
  if(confirm('Clear all stored variables?')){
    clearVarsCookie();
    renderVars();
  }
});

/* ---------------- Settings (appearance) ---------------- */
const modal = document.getElementById('modal');
document.getElementById('openSettings').addEventListener('click', ()=> modal.style.display = 'block');
document.getElementById('closeModal').addEventListener('click', ()=> modal.style.display = 'none');

const bgColor = document.getElementById('bgColor');
const bgImage = document.getElementById('bgImage');
const panelColor = document.getElementById('panelColor');
const accentColor = document.getElementById('accentColor');
const buttonColor = document.getElementById('buttonColor');

function applyAppearance(settings){
  if(settings.bgColor) document.documentElement.style.setProperty('--bg', settings.bgColor);
  if(settings.panelColor) document.documentElement.style.setProperty('--panel', hexToRgba(settings.panelColor, 0.6));
  if(settings.accentColor) document.documentElement.style.setProperty('--accent', settings.accentColor);
  if(settings.buttonColor) document.documentElement.style.setProperty('--btn', settings.buttonColor);
  if(settings.bgImage){
    app.style.backgroundImage = `url('${settings.bgImage}')`;
  } else {
    app.style.backgroundImage = '';
  }
}
function hexToRgba(hex, alpha){
  if(!hex) return `rgba(0,0,0,${alpha})`;
  const h = hex.replace('#','');
  const bigint = parseInt(h,16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `rgba(${r},${g},${b},${alpha})`;
}
document.getElementById('saveSettings').addEventListener('click', ()=>{
  const settings = {
    bgColor: bgColor.value,
    bgImage: bgImage.value.trim(),
    panelColor: panelColor.value,
    accentColor: accentColor.value,
    buttonColor: buttonColor.value
  };
  localStorage.setItem('calcAppearance', JSON.stringify(settings));
  applyAppearance(settings);
  modal.style.display = 'none';
});
(function loadAppearance(){
  const saved = JSON.parse(localStorage.getItem('calcAppearance')||'null');
  if(saved){
    bgColor.value = saved.bgColor || '#121212';
    bgImage.value = saved.bgImage || '';
    panelColor.value = saved.panelColor || '#000000';
    accentColor.value = saved.accentColor || '#0a84ff';
    buttonColor.value = saved.buttonColor || '#333333';
    applyAppearance(saved);
  }
})();

/* ---------------- Init ---------------- */
function init(){
  setDisplay('0');
  setSecondary('');
  renderHistory();
  renderVars();
  typedInput.focus();
}
init();

/* ---------------- Utility: expose evaluate for console debugging (optional) ---------------- */
window._calc = {
  evaluateExpression,
  variables,
  saveVarsToCookie,
  loadVarsFromCookie
};
</script>
</body>
</html>
